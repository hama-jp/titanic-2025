# 過学習分析レポート - LB 0.709の原因と対策

## 🔥 問題の概要

**v7モデル（家族グループ特徴量版）が深刻に過学習**

- **CV Score**: 0.9921（非常に高い）
- **LB Score**: 0.709（目標0.84を大きく下回る）
- **下落幅**: **-0.2831**（予測-0.08を大幅に超える）

---

## 📊 予測との比較

### 当初の予測
| シナリオ | 予測LB | CV比 | 確率 |
|---------|--------|------|------|
| 楽観的 | 0.9521 | -0.04 | 30% |
| 中立的 | 0.9121 | -0.08 | 50% ⭐ |
| 悲観的 | 0.8621 | -0.13 | 20% |

### 実際の結果
| モデル | CV | LB | 下落幅 |
|--------|----|----|--------|
| **v7** | **0.9921** | **0.709** | **-0.2831** |

→ **予測を大幅に超える過学習**

---

## 🔍 過学習の原因分析

### 1. 家族グループ生存率特徴量の問題

**問題の特徴量**:
- `FamilyGroupSurvivalRate`: 姓ベースの家族生存率
- `TicketGroupSurvivalRate`: チケットベースの生存率
- `FamilyGroupMeanAge/Fare`: 家族グループ平均値
- その他14個の家族関連集計特徴量

**なぜ過学習したか**:

#### Train内では強力（CV 0.9921）
```
Train: Smithファミリー
├─ Person A (train) → 生存
├─ Person B (train) → 生存
└─ Person C (train) → 生存
→ Smithファミリー生存率: 100%
→ 予測時にこの情報を使える ✅
```

#### Test側では機能しない（LB 0.709）
```
Case 1: Test側の共通姓（45%）
Train: Smithファミリー → 生存率 100%
Test:  Smithファミリー → この情報を使える ✅

Case 2: Test側のユニーク姓（55%） ← 問題！
Train: Johnsonファミリーなし
Test:  Johnsonファミリー → デフォルト値 0.5 ❌
→ 予測精度が大幅に低下
```

**さらに悪いケース**: 共通姓でもtrain-test間でパターンが異なる
```
Train: Brownファミリー → 全員死亡（生存率0%）
Test:  Brownファミリー → 実際は生存
→ 間違った情報を使って誤予測 ❌❌
```

### 2. Train-Test分離の影響

実データ分析結果:
- Test側の**55%が共通姓を持たない**
- Test側の**64%が共通チケットを持たない**
- → 過半数のTestデータで家族グループ特徴量が機能しない

### 3. リーク込み戦略の限界

**リーク込み特徴量の2つのタイプ**:

#### タイプA: 汎化的なリーク（機能する）
- Target Encoding（Title, Embarked, Pclass等）
- カテゴリ全体での平均的な傾向
- Train-Test間で同じカテゴリが存在すれば有効

#### タイプB: 個別的なリーク（過学習しやすい）
- 家族グループ生存率（Surname, Ticket）
- **特定の個人/グループレベル**の情報
- Train-Test間で同じ個人/家族が必要
- → **今回はここが失敗**

---

## 💡 対策モデル: v8 Generalized

### 戦略
**過学習特徴量を完全除外し、汎化的な特徴量のみ使用**

### 除外した特徴量（14個）
- `FamilyGroupSurvivalRate` ❌
- `TicketGroupSurvivalRate` ❌
- `FamilyGroupSize` ❌
- `FamilyGroupMeanAge` ❌
- `FamilyGroupMeanFare` ❌
- `TicketGroupMeanAge` ❌
- `TicketGroupMeanFare` ❌
- `FamilyAgeRank` ❌
- `FamilyFemaleCount` ❌
- `FamilyMaleCount` ❌
- `AgeDiffFromFamilyMean` ❌
- `FareDiffFromFamilyMean` ❌
- `FamilyGroupSurvivalStd` ❌
- `TicketGroupSize` ❌

### 維持した特徴量（49個）
- 基本特徴量（Age, Fare, Pclass等）
- Title, Embarked, Cabin等の汎化的カテゴリ
- Target Encoding（汎化的な集計）
- 交互作用特徴量
- 派生数値特徴量

### v8結果
- **CV Score**: 0.8462
- **予測LB**: 0.82〜0.85前後（健全な範囲）
- **特徴**: 過学習を排除し、汎化性能重視

---

## 📈 モデル比較と推奨

### 全モデルの比較

| モデル | CV | LB | CV-LB差 | 評価 | 推奨度 |
|--------|----|----|---------|------|--------|
| v1 | 0.8316 | ??? | ??? | 初期版 | △ |
| **v2** | **0.8462** | **???** | **???** | Pseudo-labeling | ⭐ |
| v3 | 0.8406 | ??? | ??? | LightGBM/XGBoost | ⭐ |
| v6 | 0.8406 | ??? | ??? | Phase 1統合 | ⭐ |
| v7 | 0.9921 | 0.709 | -0.2831 | 過学習！ | ❌ |
| **v8** | **0.8462** | **???** | **???** | 汎化性能重視 | ⭐⭐ |

### 次に試すべきモデル（優先順）

#### 1位: v8 Generalized ⭐⭐⭐
- **ファイル**: `titanic_model_v8_generalized.py`
- **提出**: `submission_v8_generalized.csv`
- **CV**: 0.8462
- **特徴**: 過学習特徴量を完全除外
- **期待LB**: 0.82〜0.85

#### 2位: v2 (Pseudo-labeling) ⭐⭐
- **ファイル**: `titanic_model_v2.py`
- **提出**: `submission_v2.csv`（既存）
- **CV**: 0.8462
- **特徴**: Pseudo-labeling、v8と同じCV
- **期待LB**: 0.82〜0.85

#### 3位: v6 (Phase 1統合) ⭐
- **ファイル**: `titanic_model_v6_optimized.py`
- **提出**: `submission_v6_optimized.csv`（既存）
- **CV**: 0.8406
- **特徴**: 特徴選択 + 閾値最適化
- **期待LB**: 0.81〜0.84

---

## 🎓 学んだ教訓

### 1. CVスコアが高すぎる時は要注意
- CV 0.99+は異常値
- 過学習の明確なシグナル
- LBで大幅下落のリスクが高い

### 2. リーク込み特徴量の使い分け
**✅ 良いリーク**: カテゴリ全体の傾向（汎化的）
- Title別の生存率
- Pclass別の傾向
- Embarked別の傾向

**❌ 悪いリーク**: 個別の情報（個別的）
- 特定家族の生存率
- 特定チケットの生存率
- → Train-Testで同じ個人/家族が必要

### 3. Train-Test分離の重要性
- Titanicデータは**意図的にtrain-testで家族を分離**している可能性
- 家族グループ特徴量は、この分離を考慮していなかった
- Real-worldデータでは、同じグループがtrain-testに分散しない

### 4. 特徴量の汎化性能を常に意識
- 特徴量追加時に「testデータでも機能するか？」を問う
- Train-Test間で共通性があるか確認
- 個別情報ではなく、一般的なパターンを捉える

---

## 🎯 今後の推奨アクション

### 即座に実施
1. **v8を提出してLBスコア確認** ⭐⭐⭐
2. v2も提出して比較（CV同じだが手法が異なる）
3. v6も保険として提出

### LB結果を見てから
- v8が0.82〜0.85なら成功
- v8が0.75以下なら、さらなる分析が必要
- 複数モデルのアンサンブルも検討

### 長期的な改善
- より汎化的な家族特徴量の設計
- Train-Test間の分布比較を事前に実施
- Stacking/Blendingで複数モデル統合

---

## 📊 結論

**v7の失敗は貴重な学び**

- 家族グループ生存率特徴量はCV上では強力だが、実際には過学習
- **v8（汎化性能重視版）が最も有望**
- CV 0.8462で健全な範囲、LBでの改善が期待できる

**最優先推奨**: `submission_v8_generalized.csv` を提出 ⭐⭐⭐

---

**作成日**: 2025-11-13
**v7 LB結果**: 0.709（深刻な過学習）
**推奨モデル**: v8 Generalized (CV 0.8462)

# v2 vs v3 詳細比較

## v3の改善内容

交互作用特徴を4つ厳選して追加：

1. **Sex_Pclass** - 救命優先度の直接表現
2. **Sex_AgeBin** - 年齢層×性別の組み合わせ
3. **Child_Pclass** - 子供×階級
4. **Pclass_FarePP** - 階級×実質単価のズレ検出

**戦略**: 浅い木（max_depth=4）の弱点を交互作用で補う

---

## スコア比較

| 指標 | v2 | v3 | 差分 |
|------|----|----|------|
| **OOF Accuracy** | **84.18%** | 83.39% | **-0.79pt** |
| **OOF AUC** | **88.21%** | 87.80% | **-0.41pt** |
| **特徴量数** | 19 | 23 | +4 |
| **テスト予測の違い** | - | 5/418 (1.2%) | - |

---

## Fold別詳細（Accuracy）

| Fold | v2 | v3 | 差分 | 評価 |
|------|----|----|------|------|
| 1 | 85.47% | 84.92% | -0.55pt | ✗ |
| 2 | 87.08% | 86.52% | -0.56pt | ✗ |
| 3 | 79.78% | **80.34%** | **+0.56pt** | ✓ |
| 4 | 84.27% | 82.58% | -1.69pt | ✗ |
| 5 | 84.27% | 82.58% | -1.69pt | ✗ |

**観察**:
- Fold 3のみ改善（+0.56pt）
- Fold 4, 5で大きく低下（-1.69pt）
- 全体として不安定化

---

## Fold別詳細（AUC）

| Fold | v2 | v3 | 差分 | 評価 |
|------|----|----|------|------|
| 1 | 90.63% | 89.58% | -1.05pt | ✗ |
| 2 | 87.96% | 87.91% | -0.05pt | ≈ |
| 3 | 86.28% | 86.11% | -0.17pt | ✗ |
| 4 | 87.95% | 87.48% | -0.47pt | ✗ |
| 5 | 89.48% | **89.52%** | **+0.04pt** | ≈ |

---

## 統計分析

| 指標 | v2 | v3 |
|------|----|----|
| Accuracy 平均 | 84.17% | 83.39% |
| Accuracy 標準偏差 | 2.43pt | 2.13pt |
| Accuracy 範囲 | 7.30pt | 6.18pt |

**分散は若干改善**したが、平均スコアが低下。

---

## Feature Importance分析

### v3で追加した交互作用特徴

| 特徴 | Importance | 全体順位 | 評価 |
|------|-----------|---------|------|
| **Sex_AgeBin** | 332.1 | **8位** | ✅ 効いている |
| **Sex_Pclass** | 281.2 | **9位** | ✅ 効いている |
| **Child_Pclass** | 39.7 | 17位 | ❌ 弱い |
| **Pclass_FarePP** | 2.3 | 22位 | ❌ ほぼ無効 |

### Top 10 (v3)

| Rank | Feature | Importance |
|------|---------|-----------|
| 1 | Sex | 2662.8 |
| 2 | FarePerPerson | 874.0 |
| 3 | Age | 869.7 |
| 4 | Pclass | 844.1 |
| 5 | Fare | 643.4 |
| 6 | Title | 597.1 |
| 7 | TicketGroupSize | 384.5 |
| 8 | **Sex_AgeBin** | 332.1 ← NEW! |
| 9 | **Sex_Pclass** | 281.2 ← NEW! |
| 10 | FamilySize | 250.7 |

---

## 分析と考察

### なぜv3はv2より悪化したか？

1. **有効な交互作用は2つのみ**
   - Sex_AgeBin, Sex_Pclass は重要度が高い（8-9位）
   - しかし Child_Pclass, Pclass_FarePP がノイズになっている

2. **過学習の兆候**
   - 特徴量が増えすぎた（19 → 23）
   - データ数891に対して23特徴量は多い可能性

3. **Fold 4, 5での急激な低下**
   - 特定のFoldで交互作用が裏目に出た
   - 木の分岐がより複雑になり、汎化性能が低下

### Sex_AgeBin/Sex_Pclassが効いているのにスコアが下がる理由

- これらの交互作用は**Sexと重複**している
- Sexの重要度が下がっている（v2: 2945.8 → v3: 2662.8）
- 情報を分散させただけで、新しい情報は少ない

---

## 結論と推奨アクション

### ❌ v3はv2より劣っている

- OOF Accuracy: **-0.79pt**
- 全Foldで平均的に低下
- 交互作用の半分がノイズ

### 次の選択肢

#### オプション1: v3.1を作る（推奨度: ★★☆）
**Sex_AgeBin**と**Sex_Pclass**のみ残して軽量化

**期待される効果**:
- Child_Pclass, Pclass_FarePP のノイズを除去
- v2より+0.3〜0.5pt改善の可能性

**所要時間**: 5分

#### オプション2: v2でスタッキングへ進む（推奨度: ★★★）
v2（OOF Acc: 84.18%）をベースに、LightGBM + XGBoost + CatBoostのスタッキング

**期待される効果**:
- アンサンブルで+0.5〜1.0pt改善
- より安定した予測

**所要時間**: 15-20分

#### オプション3: v1に戻る（推奨度: ★☆☆）
最もシンプルで安定（OOF Acc: 84.96%）

ただしv1はtrain+testのグループ情報を活用していない点で、v2より戦略的に劣る。

---

## 個人的推奨

1. **まずv3.1を試す**（Sex_AgeBin, Sex_Pclassのみ）
   - 所要時間が短い
   - v2より改善する可能性
   - 失敗してもv2に戻れる

2. **v2/v3.1のベストをスタッキング**
   - LightGBM + XGBoost + CatBoost
   - ロジスティック回帰メタモデル
   - 最終的な精度向上

3. **実際のLBで検証**
   - v1, v2, v3.1, スタッキング版を全て提出
   - LBスコアで最終判断

---

## 学んだ教訓

1. **交互作用は厳選すべき**
   - やみくもに追加すると逆効果
   - 重要度の低いものは潔く捨てる

2. **Titanic規模では特徴量は少なめが吉**
   - データ数891に対して23特徴量は多すぎた
   - 15-20個程度が適正か

3. **CVのFold間の一貫性が重要**
   - Fold 3だけ改善、他は低下 = 不安定
   - 全Foldで平均的に改善する方が信頼できる

4. **情報の重複に注意**
   - Sex_Pclass は Sex と Pclass の情報を含む
   - 新しい情報を追加できているか検証が必要

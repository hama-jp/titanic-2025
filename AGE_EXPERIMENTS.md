# Age関連特徴量の実験（v2.5, v2.6）

## 実験目的

ユーザーからの質問: **「AgeBinの削除もしくはAgeの削除は？」**

検証内容:
- v2.5: AgeBin削除（Age保持）
- v2.6: Age削除（AgeBin保持）

## 背景

v2.2のFeature Importance:
- **Age: 873.9**（高い）
- **AgeBin: 0.647**（最下位）

一見するとAgeBinが削除候補に見えるが、両方試してみた。

## 実験結果

### スコア比較

| バージョン | OOF Accuracy | OOF AUC | 特徴量数 | 変更点 | 結果 |
|-----------|-------------|---------|---------|--------|------|
| **v2.2** | 84.29% | 88.52% | 17 | 基準 | - |
| v2.5 | 83.84% | 88.64% | 16 | AgeBin削除 | ❌ 悪化 |
| **v2.6** | **85.19%** | **88.67%** | 16 | Age削除 | ✅ **大成功** |

### v2.5: AgeBin削除（失敗）

**結果:**
- OOF Accuracy: 83.84% (**-0.45pt** from v2.2) ❌
- OOF AUC: 88.64% (+0.12pt from v2.2)

**Fold別:**
```
Fold 1: 86.59% (v2.2: 85.48% → +1.11pt)
Fold 2: 87.08% (v2.2: 87.08% → ±0.00pt)
Fold 3: 79.21% (v2.2: 80.34% → -1.13pt)
Fold 4: 83.15% (v2.2: 83.71% → -0.56pt)
Fold 5: 83.15% (v2.2: 84.83% → -1.68pt)
```

**Feature Importance変化:**
```
Age: 1024.9 (v2.2: 873.9 → 増加)
```

Ageの重要度が上昇したが、全体的には悪化。

---

### v2.6: Age削除（大成功！）⭐

**結果:**
- OOF Accuracy: 85.19% (**+0.90pt** from v2.2) ✅
- OOF AUC: 88.67% (**+0.15pt** from v2.2) ✅
- 特徴量数: 17 → 16

**これまでの全バージョンで最高スコア！**

**Fold別:**
```
Fold 1: 85.47% (v2.2: 85.48% → -0.01pt)
Fold 2: 87.08% (v2.2: 87.08% → ±0.00pt)
Fold 3: 83.71% (v2.2: 80.34% → +3.37pt) 🚀
Fold 4: 84.83% (v2.2: 83.71% → +1.12pt) ✅
Fold 5: 84.83% (v2.2: 84.83% → ±0.00pt)
```

**特にFold 3で+3.37ptの大幅改善！**

**Feature Importance変化:**
```
v2.2 (Age + AgeBin):
Age:     873.9
AgeBin:    0.647 (最下位)
IsChild: 128.7

v2.6 (AgeBinのみ):
AgeBin:  47.8 (大幅上昇！)
IsChild: 446.6 (3.5倍に上昇！🚀)
```

IsChildの重要度が128.7 → 446.6と**3.5倍**に上昇！

---

## 分析

### なぜAgeBin削除が失敗したのか

**1. AgeBinは低Importanceだが必要な情報を提供**
- AgeBinは年齢のカテゴリ区間（Child, Teen, Young, Mid, Senior）
- 連続値Ageとは異なる粒度の情報
- 木構造モデルにとって分岐しやすい形式

**2. v2.4のIsAlone削除失敗と類似**
- IsAlone削除: -0.23pt（数学的冗長だがモデル的有用）
- AgeBin削除: -0.45pt（低Importanceだが必要）
- **Feature Importanceが低い ≠ 不要**

---

### なぜAge削除が大成功したのか 🎉

**1. 年齢情報は他の特徴量で十分カバーされている**

Ageの情報を持つ他の特徴量:
- **AgeBin**: 年齢の区間情報（5カテゴリ）
- **IsChild**: 12歳以下フラグ（Age <= 12）
- **IsMother**: 母親判定（Title + Age + Parch）
- **Title**: Mr, Miss, Mrs, Master（年齢と社会的地位を反映）

これらがAgeの情報を**より良い形**で表現している。

**2. Ageの連続値がノイズになっていた**

問題点:
- 欠損値を中央値・Title別中央値で補完 → 不正確
- 連続値の細かい差異が過学習を招いた
- 25歳と30歳の差が本当に意味があるのか？

解決策:
- AgeBinによるカテゴリ化で適切な粒度に
- IsChildで重要な境界（12歳）を明示
- Titleで社会的地位を考慮

**3. 多重共線性の解消**

Ageは以下と相関:
- AgeBin（完全に導出される）
- IsChild（Age <= 12）
- IsMother（部分的に関連）
- Title（Master = 子供、Mr/Mrs = 大人）

Age削除で多重共線性が減り、他の特徴量が本来の力を発揮。

**4. IsChildの重要度が爆発的に上昇**

```
v2.2: IsChild = 128.7
v2.6: IsChild = 446.6 (3.5倍！)
```

Ageがあると「Age自体で判定」されてしまい、IsChildの価値が埋もれていた。
Age削除で「子供かどうか」のバイナリフラグが重要な役割を果たすようになった。

---

## 重要な発見: Feature Importanceの逆転現象

### 高Importance ≠ 必要

**Age（v2.2）:**
- Feature Importance: **873.9**（高い）
- 削除結果: **+0.90pt** ✅（大成功）
- 結論: **高Importanceでも削除すべき**

**AgeBin（v2.2）:**
- Feature Importance: **0.647**（最下位）
- 削除結果: **-0.45pt** ❌（失敗）
- 結論: **低Importanceでも必要**

### なぜこの逆転が起きるのか？

**1. Importanceは「使われた頻度」を測定**
- Ageは連続値で多くの分岐に使われる → 高Importance
- しかし情報の質は低い（ノイズ含む）

**2. AgeBinは「効率的な分岐」を提供**
- カテゴリ変数で分岐回数は少ない → 低Importance
- しかし情報の質は高い（適切な粒度）

**3. 冗長性の問題**
- Ageの情報はAgeBin, IsChild, Titleで代替可能
- Age自体が冗長でノイズになっていた

---

## 他の削除実験との比較

| 削除特徴量 | Importance | Accuracy変化 | 理由 | 判定 |
|-----------|-----------|-------------|------|------|
| SibSp/Parch (v2.2) | 26, 25 | +0.11pt | 完全冗長 | ✅ 成功 |
| HasFamilyMatch (v2.1) | 5.10 | -0.79pt | 相互作用 | ❌ 失敗 |
| Fare (v2.3) | 873.9 | -0.45pt | 補完的情報 | ❌ 失敗 |
| IsAlone (v2.4) | 2.998 | -0.23pt | モデル的有用 | ❌ 微妙 |
| **AgeBin (v2.5)** | **0.647** | **-0.45pt** | **低Importanceでも必要** | ❌ **失敗** |
| **Age (v2.6)** | **873.9** | **+0.90pt** | **高Importanceでも冗長** | ✅ **大成功** |

### パターン分析

**削除成功（+改善）:**
1. SibSp/Parch: 完全冗長（数学的）
2. **Age: 高Importanceだが冗長（他特徴量で代替可能）** ⭐ NEW

**削除失敗（-悪化）:**
1. HasFamilyMatch: 低Importanceだが相互作用で重要
2. Fare: 高Importanceで補完的情報を提供
3. IsAlone: 低Importanceだがモデル的有用性
4. **AgeBin: 最低Importanceだが必要な情報** ⭐ NEW

---

## 全バージョン最終比較

| バージョン | OOF Accuracy | OOF AUC | 特徴量数 | 評価 |
|-----------|-------------|---------|---------|------|
| v1 | 84.96% | 88.41% | 16 | 旧最高Accuracy |
| v2 | 84.18% | 88.21% | 19 | 戦略的正解 |
| v2.2 | 84.29% | 88.52% | 17 | 旧推奨版 |
| v2.3 | 83.84% | 88.20% | 16 | Fare削除失敗 |
| v2.4 | 84.06% | 88.47% | 16 | IsAlone削除微妙 |
| v2.5 | 83.84% | 88.64% | 16 | AgeBin削除失敗 |
| **v2.6** | **85.19%** 👑 | **88.67%** 👑 | **16** | **NEW最高！** |

### v1 vs v2.6比較

v2.6がv1（旧最高）を超えた！

| 指標 | v1 | v2.6 | 差分 |
|-----|-----|------|------|
| Accuracy | 84.96% | **85.19%** | **+0.23pt** ✅ |
| AUC | 88.41% | **88.67%** | **+0.26pt** ✅ |
| 特徴量数 | 16 | 16 | 同じ |

同じ16特徴量でv1より高精度！

---

## 結論

### ✅ v2.6（Age削除）が最終推奨版

**スコア:**
- OOF Accuracy: **85.19%**（全バージョン中最高）
- OOF AUC: **88.67%**（全バージョン中最高）
- 特徴量数: **16個**（シンプル）

**特徴量構成:**
```python
features = [
    # 数値
    'Fare', 'FarePerPerson',
    'FamilySize', 'TicketGroupSize', 'FamilyGroupSize', 'CabinGroupSize',
    # カテゴリ
    'Sex', 'Pclass', 'Embarked', 'Title', 'Deck', 'AgeBin',
    # フラグ
    'IsAlone', 'IsChild', 'IsMother', 'HasFamilyMatch'
]
```

**提出ファイル:** `submission_restart_v2_6.csv`

---

## 重要な教訓

### 1. Feature Importanceだけでは判断できない

**高Importance ≠ 必要**
- Age: 873.9だが削除で+0.90pt改善

**低Importance ≠ 不要**
- AgeBin: 0.647だが削除で-0.45pt悪化

### 2. 冗長性の種類を見極める

**削除すべき冗長性:**
- 完全な数学的冗長（SibSp/Parch → FamilySize）
- 他特徴量で完全代替可能（Age → AgeBin + IsChild + Title）

**削除してはいけない:**
- 低Importanceでも独自の価値がある（AgeBin, HasFamilyMatch）
- 補完的情報を提供（Fare, FarePerPerson）

### 3. 多重共線性を解消すると性能向上

Age削除により:
- 他の年齢関連特徴量（IsChild, AgeBin）が本来の力を発揮
- IsChildの重要度が3.5倍に上昇
- Fold 3で+3.37ptの大幅改善

### 4. 連続値 vs カテゴリ値

木構造モデルでは:
- 連続値（Age）: 細かい分岐が可能だがノイズも多い
- カテゴリ値（AgeBin）: 粗い分岐だが適切な粒度で安定

特に欠損値補完が必要な場合、カテゴリ化の方が有効。

---

## 次のステップ

v2.6を最終版として:
1. Kaggleに提出
2. FINAL_SUMMARY_RESTART.mdを更新
3. 残りの実験候補（あれば）を検討

**これ以上の特徴量削除は推奨しない** - v2.6が最適バランス
